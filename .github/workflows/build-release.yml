name: Build and Release

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-backend:
    name: Build Backend Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create backend distribution package
        run: |
          mkdir -p releases
          cd backend
          zip -r ../releases/horus_backend_$(date +%Y%m%d).zip . \
            -x "__pycache__/*" \
            -x "*/__pycache__/*" \
            -x "*/*/__pycache__/*" \
            -x ".pytest_cache/*" \
            -x "**/*.pyc" \
            -x "*.pyc"
          cd ..
          ls -lh releases/

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: horus-backend
          path: releases/horus_backend_*.zip
          if-no-files-found: error

  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        include:
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build for ${{ matrix.platform }}
        run: npm run build:${{ matrix.platform }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List dist directory (Debug)
        shell: bash
        run: ls -la dist/ || echo "No dist directory"

      - name: Upload Mac artifacts
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: horus-mac
          path: |
            dist/*.dmg
            dist/*.zip
          if-no-files-found: warn

      - name: Upload Windows artifacts
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: horus-windows
          path: |
            dist/*.exe
          if-no-files-found: warn

  release:
    name: Create Release
    needs: [build, build-backend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-mac
          path: ./artifacts/mac

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-windows
          path: ./artifacts/windows

      - name: Download Backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-backend
          path: ./artifacts/backend

      - name: List artifacts
        run: |
          echo "Mac artifacts:"
          ls -la ./artifacts/mac/ || echo "No Mac artifacts"
          echo "Windows artifacts:"
          ls -la ./artifacts/windows/ || echo "No Windows artifacts"
          echo "Backend artifacts:"
          ls -la ./artifacts/backend/ || echo "No Backend artifacts"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/mac/*
            ./artifacts/windows/*
            ./artifacts/backend/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # üéâ HORUS Trading Platform Release

            ## üì¶ Downloads

            ### Frontend Applications

            **macOS**
            - **HORUS-{version}.dmg** - macOS Installer (recommended)
            - **HORUS-{version}-mac.zip** - macOS Archive

            **Windows**
            - **HORUS Setup {version}.exe** - Windows Installer (recommended)
            - **HORUS {version}.exe** - Windows Portable

            ### Backend (Required)
            - **horus_backend_*.zip** - Python backend with AI/ML components
              - AI Diffusion Model for price forecasting
              - Virtual Economy Simulation (100+ trader agents)
              - Pattern Recognition (18+ chart patterns)
              - Trading Anarchy 4-Push Detection
              - OANDA & CryptoCompare API integration
              - Self-training mechanism

            ## ‚ú® Features

            - ü§ñ AI-Powered Predictions with Diffusion Models
            - üìä TradingView Lightweight Charts
            - üéØ Pattern Recognition (Double Bottom/Top, H&S, Flags, Pennants, Tea Cup, etc.)
            - üî¥ Trading Anarchy 4-Push Exhaustion Detection
            - üíº Virtual Economy Simulation
            - üìà Multi-Indicator Technical Analysis
            - ‚öôÔ∏è Liquid Glass TradeLocker-Style UI

            ## üöÄ Getting Started

            ### 1. Download Files
            - Frontend installer for your platform (macOS/Windows)
            - Backend package (horus_backend_*.zip)

            ### 2. Install Frontend
            Run the installer for your platform

            ### 3. Setup Backend
            ```bash
            unzip horus_backend_*.zip
            cd backend
            python3 -m venv venv
            source venv/bin/activate  # Windows: venv\Scripts\activate
            pip install -r requirements.txt
            python app.py
            ```

            ### 4. Launch HORUS
            Start the frontend application and begin trading!

            ## üìñ Documentation

            - [Main README](https://github.com/itsgiddd/Horus/blob/main/README.md)
            - [Development Guide](https://github.com/itsgiddd/Horus/blob/main/DEVELOPMENT.md)
            - [Backend API Docs](https://github.com/itsgiddd/Horus/blob/main/backend/README.md)

            ## ‚ö†Ô∏è Disclaimer

            This software is for educational purposes only. Trading carries risk. Not financial advice.

            ---

            Built with vision. Powered by AI. ìÇÄ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  manual-release:
    name: Manual Release
    needs: [build, build-backend]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-mac
          path: ./artifacts/mac

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-windows
          path: ./artifacts/windows

      - name: Download Backend artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-backend
          path: ./artifacts/backend

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: HORUS ${{ github.event.inputs.version }}
          files: |
            ./artifacts/mac/*
            ./artifacts/windows/*
            ./artifacts/backend/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # üéâ HORUS Trading Platform ${{ github.event.inputs.version }}

            ## üì¶ Downloads

            ### Frontend Applications

            **macOS**
            - **HORUS.dmg** - macOS Installer (recommended)
            - **HORUS-mac.zip** - macOS Archive

            **Windows**
            - **HORUS Setup.exe** - Windows Installer (recommended)
            - **HORUS.exe** - Windows Portable

            ### Backend Package (Required)
            - **horus_backend_*.zip** - Complete Python backend
              - AI Diffusion Model (DDPM) for time series forecasting
              - Virtual Economy with 100+ simulated trader agents
              - Pattern Recognition: 18+ patterns (H&S, Flags, Tea Cup, etc.)
              - Trading Anarchy 4-Push Exhaustion Detection
              - OANDA API (forex) & CryptoCompare API (crypto)
              - Self-training mechanism with automatic retraining
              - Export/download functionality for models

            ## ‚ú® Features

            - ü§ñ **AI Diffusion Model** - Advanced DDPM for price predictions
            - üéØ **Pattern Recognition** - 18+ chart patterns with confidence scoring
            - üî¥ **Trading Anarchy** - 4-push exhaustion detection system
            - üèõÔ∏è **Virtual Economy** - 100+ agent simulation for scenario analysis
            - üìä **TradingView Charts** - Professional lightweight charts
            - üíé **Liquid Glass UI** - TradeLocker-style modern interface
            - üìà **Multi-Indicator Analysis** - RSI, MACD, BB, Stochastic, ATR
            - ‚öôÔ∏è **Dual Mode** - Self-contained or live API trading

            ## üöÄ Quick Start

            ### 1. Download
            - Frontend installer for your OS
            - Backend package (horus_backend_*.zip)

            ### 2. Install Frontend
            Run the installer for your platform

            ### 3. Setup Backend
            ```bash
            unzip horus_backend_*.zip
            cd backend
            python3 -m venv venv
            source venv/bin/activate  # Windows: venv\Scripts\activate
            pip install -r requirements.txt
            python app.py
            ```

            ### 4. Configure (Optional)
            For live trading, edit `backend/.env`:
            - Add OANDA_API_KEY for forex
            - Add CRYPTOCOMPARE_API_KEY for crypto

            (Backend works without API keys in self-contained mode)

            ### 5. Launch
            Start HORUS and begin trading!

            ## üìñ Documentation

            - [Main README](https://github.com/itsgiddd/Horus/blob/main/README.md)
            - [Development Guide](https://github.com/itsgiddd/Horus/blob/main/DEVELOPMENT.md)
            - [Backend API Docs](https://github.com/itsgiddd/Horus/blob/main/backend/README.md)

            ## üõ†Ô∏è Tech Stack

            - Electron + React + TradingView
            - Python + Flask + Socket.IO
            - Machine Learning Signal Generation

            ## ‚ö†Ô∏è Disclaimer

            This software is for educational and informational purposes only. Trading carries significant risk. Not financial advice. Use at your own discretion.

            ---

            **Built with ‚òï and vision. Powered by AI.**
            ìÇÄ HORUS ¬© 2025
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
