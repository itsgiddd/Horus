name: Build and Release

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        include:
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build for ${{ matrix.platform }}
        run: npm run build:${{ matrix.platform }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List dist directory (Debug)
        shell: bash
        run: ls -la dist/ || echo "No dist directory"

      - name: Upload Mac artifacts
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: horus-mac
          path: |
            dist/*.dmg
            dist/*.zip
          if-no-files-found: warn

      - name: Upload Windows artifacts
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: horus-windows
          path: |
            dist/*.exe
          if-no-files-found: warn

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-mac
          path: ./artifacts/mac

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-windows
          path: ./artifacts/windows

      - name: List artifacts
        run: |
          echo "Mac artifacts:"
          ls -la ./artifacts/mac/ || echo "No Mac artifacts"
          echo "Windows artifacts:"
          ls -la ./artifacts/windows/ || echo "No Windows artifacts"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/mac/*
            ./artifacts/windows/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # üéâ HORUS Trading Platform Release

            ## üì¶ Downloads

            ### macOS
            - **HORUS-{version}.dmg** - macOS Installer (recommended)
            - **HORUS-{version}-mac.zip** - macOS Archive

            ### Windows
            - **HORUS Setup {version}.exe** - Windows Installer (recommended)
            - **HORUS {version}.exe** - Windows Portable

            ## ‚ú® Features

            - üìä Real-time Portfolio Dashboard
            - üìà TradingView Chart Integration
            - ‚ö° AI Trading Signals
            - üíº Portfolio Management
            - üõ°Ô∏è Risk Management Analytics
            - üîî Notification System
            - ‚öôÔ∏è Customizable Settings

            ## üöÄ Getting Started

            1. Download the appropriate installer for your platform
            2. Install the application
            3. Set up the Python backend (see [backend/README.md](https://github.com/itsgiddd/Horus/blob/main/backend/README.md))
            4. Launch HORUS and start trading!

            ## üìñ Documentation

            - [Main README](https://github.com/itsgiddd/Horus/blob/main/README.md)
            - [Development Guide](https://github.com/itsgiddd/Horus/blob/main/DEVELOPMENT.md)
            - [Backend API Docs](https://github.com/itsgiddd/Horus/blob/main/backend/README.md)

            ## ‚ö†Ô∏è Disclaimer

            This software is for educational purposes only. Trading carries risk. Not financial advice.

            ---

            Built with vision. Powered by AI. ìÇÄ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  manual-release:
    name: Manual Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-mac
          path: ./artifacts/mac

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: horus-windows
          path: ./artifacts/windows

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: HORUS ${{ github.event.inputs.version }}
          files: |
            ./artifacts/mac/*
            ./artifacts/windows/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # üéâ HORUS Trading Platform ${{ github.event.inputs.version }}

            ## üì¶ Downloads

            ### macOS
            - **HORUS.dmg** - macOS Installer (recommended)
            - **HORUS-mac.zip** - macOS Archive

            ### Windows
            - **HORUS Setup.exe** - Windows Installer (recommended)
            - **HORUS.exe** - Windows Portable

            ## ‚ú® Features

            - üìä Real-time Portfolio Dashboard with P&L tracking
            - üìà TradingView Chart Integration with multiple timeframes
            - ‚ö° AI Trading Signals with confidence scoring
            - üíº Portfolio Management with performance analytics
            - üõ°Ô∏è Advanced Risk Management (VaR, Sharpe Ratio, Diversification)
            - üîî Desktop Notification System
            - ‚öôÔ∏è Customizable Settings and API Configuration

            ## üöÄ Quick Start

            1. **Download** the installer for your platform
            2. **Install** the application
            3. **Set up Backend** (required):
               ```bash
               cd backend
               python3 -m venv venv
               source venv/bin/activate  # Windows: venv\Scripts\activate
               pip install -r requirements.txt
               python app.py
               ```
            4. **Launch HORUS** and start trading!

            ## üìñ Documentation

            - [Main README](https://github.com/itsgiddd/Horus/blob/main/README.md)
            - [Development Guide](https://github.com/itsgiddd/Horus/blob/main/DEVELOPMENT.md)
            - [Backend API Docs](https://github.com/itsgiddd/Horus/blob/main/backend/README.md)

            ## üõ†Ô∏è Tech Stack

            - Electron + React + TradingView
            - Python + Flask + Socket.IO
            - Machine Learning Signal Generation

            ## ‚ö†Ô∏è Disclaimer

            This software is for educational and informational purposes only. Trading carries significant risk. Not financial advice. Use at your own discretion.

            ---

            **Built with ‚òï and vision. Powered by AI.**
            ìÇÄ HORUS ¬© 2025
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
